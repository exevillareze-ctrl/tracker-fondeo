<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Cuentas de Fondeo</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: white;
      margin: 0;
      padding: 0;
    }

    /* ====== TOP BAR ====== */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #111827;
      padding: 10px 20px;
      border-bottom: 1px solid #1f2933;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #8b5cf6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .brand-title {
      font-size: 14px;
      font-weight: 700;
    }
    .brand-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    .nav-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      padding: 6px 16px;
      cursor: pointer;
      font-size: 12px;
    }
    .nav-btn-active {
      background: #8b5cf6;
      border-color: #8b5cf6;
      color: white;
    }

    /* ====== PAGE LAYOUT ====== */
    .page {
      padding: 20px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 30px;
      margin-bottom: 15px;
    }
    h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .card-container {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .card {
      background: #161b22;
      padding: 20px;
      border-radius: 10px;
      flex: 1;
      min-width: 220px;
      text-align: center;
    }
    .label { font-size: 14px; color: #aaa; }
    .value { font-size: 28px; margin-top: 5px; }
    .positive { color: #4CAF50; }
    .negative { color: #FF5252; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #161b22;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    th {
      background-color: #21262d;
      text-align: left;
    }
    .tag {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      color: white;
    }
    .tag-eval { background-color: #f39c12; }
    .tag-live { background-color: #2ecc71; }
    .tag-status { background-color: #3498db; }
    .tag-status-failed { background-color: #e74c3c; }
    .tag-expense { background-color: #e74c3c; }
    .tag-withdrawal { background-color: #2ecc71; }

    #error {
      background: #ff4444;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }

    section { margin-top: 10px; }
    .hidden { display: none; }

    /* LOGIN */
    .login-box {
      max-width: 320px;
      background: #161b22;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .login-input {
      width: 100%;
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #0d1117;
      color: #e5e7eb;
      font-size: 14px;
    }
    .login-btn {
      width: 100%;
      margin-top: 15px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: #8b5cf6;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    /* FORMULARIOS CUENTAS / MOVIMIENTOS */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .form-box {
      background: #161b22;
      padding: 16px 18px;
      border-radius: 10px;
      font-size: 14px;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .form-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .form-input,
    .form-select {
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #0d1117;
      color: #e5e7eb;
      font-size: 13px;
    }
    .form-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
    }
    .form-submit {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #8b5cf6;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }
    .form-msg {
      margin-top: 6px;
      font-size: 12px;
    }
    .form-msg-ok {
      color: #4caf50;
    }
    .form-msg-error {
      color: #ff5252;
    }

    /* ACCIONES */
    .actions-cell {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .action-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 7px;
      font-size: 12px;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
    }
    .action-btn.edit { border: 1px solid #4b5563; }
    .action-btn.fail { border: 1px solid #e74c3c; }
    .action-btn.activate { border: 1px solid #22c55e; }
    .action-btn.reset { border: 1px solid #f97316; }

    /* MODALES */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #111827;
      border-radius: 12px;
      padding: 20px 22px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    .modal-close {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 18px;
      cursor: pointer;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 14px;
    }
    .btn-secondary {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-primary {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #8b5cf6;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-danger {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #e74c3c;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-success {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-warning {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #f97316;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .modal-danger-box {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background: #2b0f10;
      border: 1px solid #e74c3c;
      font-size: 13px;
    }
  </style>
</head>

<body>

  <!-- BARRA SUPERIOR -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-logo">T</div>
      <div class="brand-text">
        <div class="brand-title">TRACKER</div>
        <div class="brand-subtitle">Franco Trading</div>
      </div>
    </div>
    <div class="nav-buttons">
      <button class="nav-btn nav-btn-active" id="btnDashboard">Dashboard</button>
      <button class="nav-btn" id="btnAccounts">Cuentas</button>
      <button class="nav-btn" id="btnLogin">Login</button>
    </div>
  </div>

  <div class="page">
    <div id="error"></div>

    <!-- SECCIÓN DASHBOARD -->
    <section id="dashboardSection">
      <h1>Dashboard de Cuentas de Fondeo</h1>

      <div class="card-container">
        <div class="card">
          <div class="label">EVALUACIONES</div>
          <div class="value" id="evaluations">-</div>
        </div>
        <div class="card">
          <div class="label">CUENTAS LIVE</div>
          <div class="value" id="liveAccounts">-</div>
        </div>
        <div class="card">
          <div class="label">FUNDING RATIO</div>
          <div class="value" id="fundingRatio">-</div>
        </div>
        <div class="card">
          <div class="label">GASTOS TOTALES</div>
          <div class="value" id="expenses">-</div>
        </div>
        <div class="card">
          <div class="label">GANANCIAS TOTALES</div>
          <div class="value" id="withdrawals">-</div>
        </div>
        <div class="card">
          <div class="label" id="netProfitLabel">BENEFICIO NETO</div>
          <div class="value" id="netProfit">-</div>
        </div>
      </div>
    </section>

    <!-- SECCIÓN CUENTAS -->
    <section id="accountsSection" class="hidden">
      <h2>Cuentas</h2>

      <div class="form-grid">
        <!-- Alta cuenta -->
        <div class="form-box">
          <h3>Agregar cuenta</h3>
          <div class="form-row">
            <label class="form-label" for="accName">Nombre / etiqueta</label>
            <input id="accName" class="form-input" placeholder="Ej: FT 100k eval dic-25" />
          </div>
          <div class="form-row">
            <label class="form-label" for="accType">Tipo</label>
            <select id="accType" class="form-select">
              <option value="evaluation">Evaluación</option>
              <option value="live">Live</option>
            </select>
          </div>
          <div class="form-row">
            <label class="form-label" for="accStatus">Estado (visual)</label>
            <input id="accStatus" class="form-input" placeholder="activa / quemada / etc (solo visual)" />
          </div>
          <div class="form-row">
            <label class="form-label" for="accPrice">Precio (USD)</label>
            <input id="accPrice" type="number" step="0.01" class="form-input" />
          </div>
          <div class="form-row">
            <label class="form-label" for="accSize">Tamaño de cuenta</label>
            <input id="accSize" type="number" class="form-input" placeholder="Ej: 100000" />
          </div>
          <div class="form-row">
            <label class="form-label" for="accStart">Fecha de inicio</label>
            <input id="accStart" type="date" class="form-input" />
          </div>
          <div class="form-actions">
            <button class="form-submit" id="saveAccountBtn">Guardar cuenta</button>
          </div>
          <div id="accountMsg" class="form-msg"></div>
        </div>

        <!-- Alta movimiento -->
        <div class="form-box">
          <h3>Registrar movimiento</h3>
          <div class="form-row">
            <label class="form-label" for="txType">Tipo de movimiento</label>
            <select id="txType" class="form-select">
              <option value="expense">Gasto (compra, mensualidad, fee)</option>
              <option value="withdrawal">Retiro</option>
            </select>
          </div>
          <div class="form-row">
            <label class="form-label" for="txAmount">Monto (USD)</label>
            <input id="txAmount" type="number" step="0.01" class="form-input" />
          </div>
          <div class="form-actions">
            <button class="form-submit" id="saveTxBtn">Guardar movimiento</button>
          </div>
          <div id="txMsg" class="form-msg"></div>
        </div>
      </div>

      <!-- Tabla de cuentas -->
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Empresa</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Precio</th>
            <th>Tamaño</th>
            <th>Inicio</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="accountsTableBody"></tbody>
      </table>

      <!-- Tabla de movimientos -->
      <h2>Movimientos</h2>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Monto</th>
          </tr>
        </thead>
        <tbody id="txTableBody"></tbody>
      </table>
    </section>

    <!-- SECCIÓN LOGIN -->
    <section id="loginSection" class="hidden">
      <h2>Login</h2>

      <div class="login-box">
        <label for="loginEmail">Email</label>
        <input
          id="loginEmail"
          type="email"
          class="login-input"
          placeholder="tu@email.com"
        />

        <label for="loginPassword">Contraseña</label>
        <input
          id="loginPassword"
          type="password"
          class="login-input"
          placeholder="********"
        />

        <button class="login-btn" id="loginButton">
          Iniciar sesión (no funcional aún)
        </button>
      </div>
    </section>
  </div>

  <!-- MODALES -->

  <!-- Editar cuenta -->
  <div id="modalEdit" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Editar Cuenta</div>
        <button class="modal-close" data-close-edit>&times;</button>
      </div>
      <div class="form-row">
        <label class="form-label" for="editName">Nombre de la cuenta</label>
        <input id="editName" class="form-input" />
      </div>

      <div class="modal-danger-box">
        <strong>Zona de peligro</strong><br />
        Eliminará la cuenta de forma permanente.
        <div class="modal-footer" style="justify-content:flex-start; margin-top:8px;">
          <button class="btn-danger" id="btnDeleteAccount">Eliminar Cuenta Permanentemente</button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" data-close-edit>Cancelar</button>
        <button class="btn-primary" id="btnSaveEdit">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <!-- Fallar evaluación -->
  <div id="modalFail" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Fallar Evaluación</div>
        <button class="modal-close" data-close-fail>&times;</button>
      </div>
      <p id="failText" style="font-size:14px; margin-top:4px;"></p>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-fail>Cancelar</button>
        <button class="btn-danger" id="btnConfirmFail">Fallar</button>
      </div>
    </div>
  </div>

  <!-- Activar cuenta -->
  <div id="modalActivate" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Activar Cuenta</div>
        <button class="modal-close" data-close-activate>&times;</button>
      </div>
      <div class="form-row">
        <label class="form-label" for="activateName">Nombre</label>
        <input id="activateName" class="form-input" disabled />
      </div>
      <div class="form-row">
        <label class="form-label" for="activateFee">Tarifa de Activación (USD)</label>
        <input id="activateFee" type="number" step="0.01" class="form-input" />
      </div>
      <div class="form-row">
        <label class="form-label" for="activateDate">Fecha</label>
        <input id="activateDate" type="date" class="form-input" />
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-activate>Cancelar</button>
        <button class="btn-success" id="btnConfirmActivate">Activar</button>
      </div>
    </div>
  </div>

  <!-- Resetear cuenta -->
  <div id="modalReset" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Resetear Cuenta</div>
        <button class="modal-close" data-close-reset>&times;</button>
      </div>
      <div class="form-row">
        <label class="form-label" for="resetName">Nombre</label>
        <input id="resetName" class="form-input" disabled />
      </div>
      <div class="form-row">
        <label class="form-label" for="resetPrice">Precio del Reset (USD)</label>
        <input id="resetPrice" type="number" step="0.01" class="form-input" />
      </div>
      <div class="form-row">
        <label class="form-label" for="resetDate">Fecha</label>
        <input id="resetDate" type="date" class="form-input" />
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-reset>Cancelar</button>
        <button class="btn-warning" id="btnConfirmReset">Resetear</button>
      </div>
    </div>
  </div>

  <!-- SUPABASE JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- JS PRINCIPAL -->
  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = "https://zflewnplzaiarasfuzcf.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbGV3bnBsemFpYXJhc2Z1emNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTIwMzEsImV4cCI6MjA4MDE4ODAzMX0.UgdX9H7QOKWpDLpApMYzCaA01oIxT9r2psnvJYfkcgg";

    const USER_ID = "00000000-0000-0000-0000-000000000001";

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let cachedAccounts = [];
    let selectedAccountId = null;

    function formatCurrency(num) {
      const n = Number(num);
      if (isNaN(n)) return "-";
      return n.toLocaleString("en-US", {
        style: "currency",
        currency: "USD",
      });
    }

    function formatDate(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    async function loadDashboard() {
      const errorBox = document.getElementById("error");
      errorBox.style.display = "none";
      errorBox.textContent = "";

      const { data: accounts, error: accError } = await supabaseClient
        .from("accounts")
        .select("*")
        .eq("user_id", USER_ID);

      if (accError) {
        console.error("Error accounts:", accError);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Error al leer cuentas: " +
          (accError.message || JSON.stringify(accError));
        return;
      }

      const { data: transactions, error: txError } = await supabaseClient
        .from("transactions")
        .select("*")
        .eq("user_id", USER_ID)
        .order("date", { ascending: false });

      if (txError) {
        console.error("Error transactions:", txError);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Error al leer movimientos: " +
          (txError.message || JSON.stringify(txError));
        return;
      }

      cachedAccounts = accounts || [];
      updateCards(cachedAccounts, transactions || []);
      updateAccountsTable(cachedAccounts);
      updateTxTable(transactions || []);
    }

    function updateCards(accounts, transactions) {
      const evals = accounts.filter((a) => a.type === "evaluation").length;
      const live = accounts.filter((a) => a.type === "live").length;

      const expenses = transactions
        .filter((t) => t.type === "expense")
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);

      const withdrawals = transactions
        .filter((t) => t.type === "withdrawal")
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);

      const net = withdrawals - expenses;

      document.getElementById("evaluations").textContent = evals;
      document.getElementById("liveAccounts").textContent = live;
      document.getElementById("fundingRatio").textContent =
        evals === 0 ? "-" : ((live / evals) * 100).toFixed(1) + "%";

      document.getElementById("expenses").textContent =
        formatCurrency(expenses);
      document.getElementById("withdrawals").textContent =
        formatCurrency(withdrawals);

      const netEl = document.getElementById("netProfit");
      const label = document.getElementById("netProfitLabel");
      netEl.textContent = formatCurrency(net);

      if (net > 0) {
        netEl.classList.add("positive");
        netEl.classList.remove("negative");
        label.textContent = "BENEFICIO NETO (positivo)";
      } else if (net < 0) {
        netEl.classList.add("negative");
        netEl.classList.remove("positive");
        label.textContent = "BENEFICIO NETO (negativo)";
      } else {
        netEl.classList.remove("positive", "negative");
        label.textContent = "BENEFICIO NETO";
      }
    }

    function updateAccountsTable(accounts) {
      const tbody = document.getElementById("accountsTableBody");
      tbody.innerHTML = "";

      if (!accounts || accounts.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 8;
        td.style.textAlign = "center";
        td.style.color = "#777";
        td.textContent = "No hay cuentas cargadas aún (conexión OK).";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      accounts.forEach((acc) => {
        const tr = document.createElement("tr");

        const typeHtml =
          '<span class="tag ' +
          (acc.type === "evaluation" ? "tag-eval" : "tag-live") +
          '">' +
          (acc.type === "evaluation" ? "Evaluación" : "Live") +
          "</span>";

        let statusClass = "tag-status";
        if (acc.status === "failed") statusClass = "tag-status-failed";

        const statusHtml =
          '<span class="tag ' + statusClass + '">' + (acc.status || "-") + "</span>";

        tr.innerHTML = `
          <td>${acc.name || "-"}</td>
          <td>-</td>
          <td>${typeHtml}</td>
          <td>${statusHtml}</td>
          <td>${formatCurrency(acc.price)}</td>
          <td>${acc.size ? Number(acc.size).toLocaleString("en-US") : "-"}</td>
          <td>${acc.start_date || "-"}</td>
          <td class="actions-cell">
            <button class="action-btn edit" data-id="${acc.id}" title="Editar">&#9998;</button>
            <button class="action-btn fail" data-id="${acc.id}" title="Fallar">&#10006;</button>
            <button class="action-btn activate" data-id="${acc.id}" title="Activar">&#10003;</button>
            <button class="action-btn reset" data-id="${acc.id}" title="Resetear">&#10227;</button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      document.querySelectorAll(".action-btn.edit").forEach((btn) =>
        btn.addEventListener("click", () =>
          openEditModal(btn.getAttribute("data-id"))
        )
      );
      document.querySelectorAll(".action-btn.fail").forEach((btn) =>
        btn.addEventListener("click", () =>
          openFailModal(btn.getAttribute("data-id"))
        )
      );
      document.querySelectorAll(".action-btn.activate").forEach((btn) =>
        btn.addEventListener("click", () =>
          openActivateModal(btn.getAttribute("data-id"))
        )
      );
      document.querySelectorAll(".action-btn.reset").forEach((btn) =>
        btn.addEventListener("click", () =>
          openResetModal(btn.getAttribute("data-id"))
        )
      );
    }

    function updateTxTable(transactions) {
      const tbody = document.getElementById("txTableBody");
      tbody.innerHTML = "";

      if (!transactions || transactions.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.style.textAlign = "center";
        td.style.color = "#777";
        td.textContent = "No hay movimientos registrados.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      transactions.forEach((tx) => {
        const tr = document.createElement("tr");

        const typeLabel = tx.type === "expense" ? "Gasto" : "Retiro";
        const typeClass = tx.type === "expense" ? "tag-expense" : "tag-withdrawal";

        tr.innerHTML = `
          <td>${formatDate(tx.date)}</td>
          <td><span class="tag ${typeClass}">${typeLabel}</span></td>
          <td>${formatCurrency(tx.amount)}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    function getAccountById(id) {
      return cachedAccounts.find((a) => String(a.id) === String(id));
    }

    // NAV
    const btnDashboard = document.getElementById("btnDashboard");
    const btnAccounts  = document.getElementById("btnAccounts");
    const btnLogin     = document.getElementById("btnLogin");

    const dashboardSection = document.getElementById("dashboardSection");
    const accountsSection  = document.getElementById("accountsSection");
    const loginSection     = document.getElementById("loginSection");

    function setActive(tab) {
      [btnDashboard, btnAccounts, btnLogin].forEach((b) =>
        b.classList.remove("nav-btn-active")
      );
      if (tab === "dashboard") btnDashboard.classList.add("nav-btn-active");
      if (tab === "accounts")  btnAccounts.classList.add("nav-btn-active");
      if (tab === "login")     btnLogin.classList.add("nav-btn-active");

      dashboardSection.classList.add("hidden");
      accountsSection.classList.add("hidden");
      loginSection.classList.add("hidden");

      if (tab === "dashboard") dashboardSection.classList.remove("hidden");
      if (tab === "accounts")  accountsSection.classList.remove("hidden");
      if (tab === "login")     loginSection.classList.remove("hidden");
    }

    btnDashboard.onclick = () => setActive("dashboard");
    btnAccounts.onclick  = () => setActive("accounts");
    btnLogin.onclick     = () => setActive("login");

    // GUARDAR CUENTA
    const saveAccountBtn = document.getElementById("saveAccountBtn");
    const accountMsg     = document.getElementById("accountMsg");

    saveAccountBtn.onclick = async () => {
      accountMsg.textContent = "";
      accountMsg.className = "form-msg";

      const name   = document.getElementById("accName").value.trim();
      const type   = document.getElementById("accType").value;
      const price  = parseFloat(document.getElementById("accPrice").value || "0");
      const size   = document.getElementById("accSize").value
        ? parseFloat(document.getElementById("accSize").value)
        : null;
      const start  = document.getElementById("accStart").value || null;

      if (!name) {
        accountMsg.textContent = "El nombre de la cuenta es obligatorio.";
        accountMsg.classList.add("form-msg-error");
        return;
      }

      const { error } = await supabaseClient.from("accounts").insert([
        {
          user_id: USER_ID,
          name,
          type,
          price,
          size,
          start_date: start,
          status: "active"
        },
      ]);

      if (error) {
        console.error("Error guardando cuenta:", error);
        accountMsg.textContent =
          "Error al guardar la cuenta: " +
          (error.message || JSON.stringify(error));
        accountMsg.classList.add("form-msg-error");
        return;
      }

      accountMsg.textContent = "Cuenta guardada correctamente.";
      accountMsg.classList.add("form-msg-ok");

      document.getElementById("accName").value = "";
      document.getElementById("accStatus").value = "";
      document.getElementById("accPrice").value = "";
      document.getElementById("accSize").value = "";
      document.getElementById("accStart").value = "";

      await loadDashboard();
    };

    // GUARDAR MOVIMIENTO
    const saveTxBtn = document.getElementById("saveTxBtn");
    const txMsg     = document.getElementById("txMsg");

    saveTxBtn.onclick = async () => {
      txMsg.textContent = "";
      txMsg.className = "form-msg";

      const type   = document.getElementById("txType").value;
      const amount = parseFloat(document.getElementById("txAmount").value || "0");

      if (!amount || amount <= 0) {
        txMsg.textContent = "Ingresá un monto válido.";
        txMsg.classList.add("form-msg-error");
        return;
      }

      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

      const { error } = await supabaseClient
        .from("transactions")
        .insert([
          {
            user_id: USER_ID,
            type,
            amount,
            date: today
          },
        ]);

      if (error) {
        console.error("Error guardando movimiento:", error);
        txMsg.textContent =
          "Error al guardar el movimiento: " +
          (error.message || JSON.stringify(error));
        txMsg.classList.add("form-msg-error");
        return;
      }

      txMsg.textContent = "Movimiento guardado correctamente.";
      txMsg.classList.add("form-msg-ok");

      document.getElementById("txAmount").value = "";

      await loadDashboard();
    };

    /* ==== MODALES: EDITAR ==== */

    const modalEdit = document.getElementById("modalEdit");
    const editNameInput = document.getElementById("editName");
    document.querySelectorAll("[data-close-edit]").forEach((btn) =>
      btn.addEventListener("click", () => modalEdit.classList.add("hidden"))
    );

    function openEditModal(id) {
      const acc = getAccountById(id);
      if (!acc) return;
      selectedAccountId = acc.id;
      editNameInput.value = acc.name || "";
      modalEdit.classList.remove("hidden");
    }

    document.getElementById("btnSaveEdit").onclick = async () => {
      const newName = editNameInput.value.trim();
      if (!newName) return;

      const { error } = await supabaseClient
        .from("accounts")
        .update({ name: newName })
        .eq("id", selectedAccountId);

      if (error) {
        alert("Error al editar la cuenta: " + (error.message || JSON.stringify(error)));
        return;
      }

      modalEdit.classList.add("hidden");
      await loadDashboard();
    };

    document.getElementById("btnDeleteAccount").onclick = async () => {
      if (!confirm("¿Seguro que querés eliminar esta cuenta permanentemente?")) return;

      const { error } = await supabaseClient
        .from("accounts")
        .delete()
        .eq("id", selectedAccountId);

      if (error) {
        alert("Error al eliminar la cuenta: " + (error.message || JSON.stringify(error)));
        return;
      }

      modalEdit.classList.add("hidden");
      await loadDashboard();
    };

    /* ==== MODAL: FALLAR EVALUACIÓN ==== */

    const modalFail = document.getElementById("modalFail");
    const failText = document.getElementById("failText");

    document.querySelectorAll("[data-close-fail]").forEach((btn) =>
      btn.addEventListener("click", () => modalFail.classList.add("hidden"))
    );

    function openFailModal(id) {
      const acc = getAccountById(id);
      if (!acc) return;
      selectedAccountId = acc.id;
      failText.textContent =
        `¿Estás seguro de marcar la cuenta "${acc.name}" como fallada?`;
      modalFail.classList.remove("hidden");
    }

    document.getElementById("btnConfirmFail").onclick = async () => {
      const { error } = await supabaseClient
        .from("accounts")
        .update({ status: "failed" })
        .eq("id", selectedAccountId);

      if (error) {
        alert("Error al fallar la cuenta: " + (error.message || JSON.stringify(error)));
        return;
      }

      modalFail.classList.add("hidden");
      await loadDashboard();
    };

    /* ==== MODAL: ACTIVAR ==== */

    const modalActivate = document.getElementById("modalActivate");
    const activateNameInput = document.getElementById("activateName");
    const activateFeeInput = document.getElementById("activateFee");
    const activateDateInput = document.getElementById("activateDate");

    document.querySelectorAll("[data-close-activate]").forEach((btn) =>
      btn.addEventListener("click", () => modalActivate.classList.add("hidden"))
    );

    function openActivateModal(id) {
      const acc = getAccountById(id);
      if (!acc) return;
      selectedAccountId = acc.id;
      activateNameInput.value = acc.name || "";
      activateFeeInput.value = "";
      const today = new Date().toISOString().slice(0,10);
      activateDateInput.value = today;
      modalActivate.classList.remove("hidden");
    }

    document.getElementById("btnConfirmActivate").onclick = async () => {
      const fee = parseFloat(activateFeeInput.value || "0");
      const date = activateDateInput.value || new Date().toISOString().slice(0,10);

      if (!fee || fee <= 0) {
        alert("Ingresá un monto de activación válido.");
        return;
      }

      const { error: accError } = await supabaseClient
        .from("accounts")
        .update({ type: "live", status: "active" })
        .eq("id", selectedAccountId);

      if (accError) {
        alert("Error al activar la cuenta: " + (accError.message || JSON.stringify(accError)));
        return;
      }

      const { error: txError } = await supabaseClient
        .from("transactions")
        .insert([
          {
            user_id: USER_ID,
            type: "expense",
            amount: fee,
            date
          }
        ]);

      if (txError) {
        alert("Cuenta activada, pero error al registrar el gasto: " + (txError.message || JSON.stringify(txError)));
      }

      modalActivate.classList.add("hidden");
      await loadDashboard();
    };

    /* ==== MODAL: RESETEAR ==== */

    const modalReset = document.getElementById("modalReset");
    const resetNameInput = document.getElementById("resetName");
    const resetPriceInput = document.getElementById("resetPrice");
    const resetDateInput = document.getElementById("resetDate");

    document.querySelectorAll("[data-close-reset]").forEach((btn) =>
      btn.addEventListener("click", () => modalReset.classList.add("hidden"))
    );

    function openResetModal(id) {
      const acc = getAccountById(id);
      if (!acc) return;
      selectedAccountId = acc.id;
      resetNameInput.value = acc.name || "";
      resetPriceInput.value = "";
      const today = new Date().toISOString().slice(0,10);
      resetDateInput.value = today;
      modalReset.classList.remove("hidden");
    }

    document.getElementById("btnConfirmReset").onclick = async () => {
      const price = parseFloat(resetPriceInput.value || "0");
      const date = resetDateInput.value || new Date().toISOString().slice(0,10);

      if (!price || price <= 0) {
        alert("Ingresá un precio de reset válido.");
        return;
      }

      const { error } = await supabaseClient
        .from("transactions")
        .insert([
          {
            user_id: USER_ID,
            type: "expense",
            amount: price,
            date
          }
        ]);

      if (error) {
        alert("Error al registrar el reset: " + (error.message || JSON.stringify(error)));
        return;
      }

      modalReset.classList.add("hidden");
      await loadDashboard();
    };

    loadDashboard();
  </script>

</body>
</html>

