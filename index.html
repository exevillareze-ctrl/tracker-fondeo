<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Cuentas de Fondeo</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: white;
      margin: 0;
      padding: 0;
    }

    /* ====== TOP BAR ====== */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #111827;
      padding: 10px 20px;
      border-bottom: 1px solid #1f2933;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #8b5cf6; /* violeta */
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .brand-title {
      font-size: 14px;
      font-weight: 700;
    }
    .brand-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    .nav-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      padding: 6px 16px;
      cursor: pointer;
      font-size: 12px;
    }
    .nav-btn-active {
      background: #8b5cf6;
      border-color: #8b5cf6;
      color: white;
    }

    /* ====== PAGE LAYOUT ====== */
    .page {
      padding: 20px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 30px;
    }

    .card-container {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .card {
      background: #161b22;
      padding: 20px;
      border-radius: 10px;
      flex: 1;
      min-width: 220px;
      text-align: center;
    }
    .label { font-size: 14px; color: #aaa; }
    .value { font-size: 28px; margin-top: 5px; }
    .positive { color: #4CAF50; }
    .negative { color: #FF5252; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #161b22;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    th {
      background-color: #21262d;
      text-align: left;
    }
    .tag {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      color: white;
    }
    .tag-eval { background-color: #f39c12; }
    .tag-live { background-color: #2ecc71; }
    .tag-status { background-color: #3498db; }

    #error {
      background: #ff4444;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }

    /* Secciones */
    section { margin-top: 10px; }
    .hidden { display: none; }
  </style>
</head>

<body>

  <!-- BARRA SUPERIOR -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-logo">T</div>
      <div class="brand-text">
        <div class="brand-title">TRACKER</div>
        <div class="brand-subtitle">Tradesfera</div>
      </div>
    </div>
    <div class="nav-buttons">
      <button class="nav-btn nav-btn-active" id="btnDashboard">Dashboard</button>
      <button class="nav-btn" id="btnAccounts">Cuentas</button>
    </div>
  </div>

  <div class="page">
    <div id="error"></div>

    <!-- SECCI√ìN DASHBOARD -->
    <section id="dashboardSection">
      <h1>Dashboard de Cuentas de Fondeo</h1>

      <div class="card-container">
        <div class="card">
          <div class="label">EVALUACIONES</div>
          <div class="value" id="evaluations">-</div>
        </div>
        <div class="card">
          <div class="label">CUENTAS LIVE</div>
          <div class="value" id="liveAccounts">-</div>
        </div>
        <div class="card">
          <div class="label">FUNDING RATIO</div>
          <div class="value" id="fundingRatio">-</div>
        </div>
        <div class="card">
          <div class="label">GASTOS TOTALES</div>
          <div class="value" id="expenses">-</div>
        </div>
        <div class="card">
          <div class="label">GANANCIAS TOTALES</div>
          <div class="value" id="withdrawals">-</div>
        </div>
        <div class="card">
          <div class="label" id="netProfitLabel">BENEFICIO NETO</div>
          <div class="value" id="netProfit">-</div>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN CUENTAS -->
    <section id="accountsSection" class="hidden">
      <h2>Cuentas</h2>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Empresa</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Precio</th>
            <th>Tama√±o</th>
            <th>Inicio</th>
          </tr>
        </thead>
        <tbody id="accountsTableBody"></tbody>
      </table>
    </section>
  </div>

  <!-- JS COMO M√ìDULO -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üîë DATOS DE TU PROYECTO SUPABASE
    const SUPABASE_URL = "https://zflewnplzaiarasfuzcf.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbGV3bnBsemFpYXJhc2Z1emNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTIwMzEsImV4cCI6MjA4MDE4ODAzMX0.UgdX9H7QOKWpDLpApMYzCaA01oIxT9r2psnvJYfkcgg";

    // Usuario fijo (vos)
    const USER_ID = "00000000-0000-0000-0000-000000000001";

    // üëâ CONEXI√ìN A SUPABASE
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("Supabase client creado:", supabaseClient);

    /* ===== FORMATO MONEDA (USD) ===== */
    function formatCurrency(num) {
      const n = Number(num);
      if (isNaN(n)) return "-";
      return n.toLocaleString("en-US", {
        style: "currency",
        currency: "USD",   // üëà ahora en d√≥lares
      });
    }

    async function loadDashboard() {
      const errorBox = document.getElementById("error");
      errorBox.style.display = "none";
      errorBox.textContent = "";

      try {
        // Cuentas
        const { data: accounts, error: accError } = await supabaseClient
          .from("accounts")
          .select("*")
          .eq("user_id", USER_ID);

        if (accError) throw accError;

        // Transacciones
        const { data: transactions, error: txError } = await supabaseClient
          .from("transactions")
          .select("*")
          .eq("user_id", USER_ID);

        if (txError) throw txError;

        console.log("Accounts:", accounts);
        console.log("Transactions:", transactions);

        updateCards(accounts, transactions);
        updateAccountsTable(accounts);

      } catch (err) {
        console.error("Error cargando datos:", err);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Error al cargar datos desde Supabase. Abr√≠ la consola (F12 ‚Üí Console) si quer√©s ver el detalle.";
      }
    }

    function updateCards(accounts, transactions) {
      const evals = accounts.filter(a => a.type === "evaluation").length;
      const live = accounts.filter(a => a.type === "live").length;

      const expenses = transactions
        .filter(t => t.type === "expense")
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);

      const withdrawals = transactions
        .filter(t => t.type === "withdrawal")
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);

      const net = withdrawals - expenses;

      document.getElementById("evaluations").textContent = evals;
      document.getElementById("liveAccounts").textContent = live;
      document.getElementById("fundingRatio").textContent =
        evals === 0 ? "-" : ((live / evals) * 100).toFixed(1) + "%";

      document.getElementById("expenses").textContent = formatCurrency(expenses);
      document.getElementById("withdrawals").textContent = formatCurrency(withdrawals);

      const netEl = document.getElementById("netProfit");
      const label = document.getElementById("netProfitLabel");
      netEl.textContent = formatCurrency(net);

      if (net > 0) {
        netEl.classList.add("positive");
        netEl.classList.remove("negative");
        label.textContent = "BENEFICIO NETO (positivo)";
      } else if (net < 0) {
        netEl.classList.add("negative");
        netEl.classList.remove("positive");
        label.textContent = "BENEFICIO NETO (negativo)";
      } else {
        netEl.classList.remove("positive", "negative");
        label.textContent = "BENEFICIO NETO";
      }
    }

    function updateAccountsTable(accounts) {
      const tbody = document.getElementById("accountsTableBody");
      tbody.innerHTML = "";

      if (!accounts || accounts.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.style.textAlign = "center";
        td.style.color = "#777";
        td.textContent = "No hay cuentas cargadas a√∫n.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      accounts.forEach(acc => {
        const tr = document.createElement("tr");

        const typeHtml =
          '<span class="tag ' +
          (acc.type === "evaluation" ? "tag-eval" : "tag-live") +
          '">' +
          (acc.type === "evaluation" ? "Evaluaci√≥n" : "Live") +
          "</span>";

        const statusHtml =
          '<span class="tag tag-status">' +
          (acc.status || "-") +
          "</span>";

        tr.innerHTML = `
          <td>${acc.name || "-"}</td>
          <td>-</td>
          <td>${typeHtml}</td>
          <td>${statusHtml}</td>
          <td>${formatCurrency(acc.price)}</td>
          <td>${acc.size ? Number(acc.size).toLocaleString("en-US") : "-"}</td>
          <td>${acc.start_date || "-"}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    // ===== NAV BAR: mostrar una secci√≥n u otra =====
    const btnDashboard = document.getElementById("btnDashboard");
    const btnAccounts = document.getElementById("btnAccounts");
    const dashboardSection = document.getElementById("dashboardSection");
    const accountsSection  = document.getElementById("accountsSection");

    btnDashboard.addEventListener("click", () => {
      btnDashboard.classList.add("nav-btn-active");
      btnAccounts.classList.remove("nav-btn-active");
      dashboardSection.classList.remove("hidden");
      accountsSection.classList.add("hidden");
    });

    btnAccounts.addEventListener("click", () => {
      btnAccounts.classList.add("nav-btn-active");
      btnDashboard.classList.remove("nav-btn-active");
      accountsSection.classList.remove("hidden");
      dashboardSection.classList.add("hidden");
    });

    // Ejecutar al cargar la p√°gina
    loadDashboard();
  </script>

</body>
</html>

