<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Cuentas de Fondeo</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: white;
      margin: 0;
      padding: 0;
    }

    /* ====== TOP BAR ====== */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #111827;
      padding: 10px 20px;
      border-bottom: 1px solid #1f2933;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #8b5cf6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .brand-title {
      font-size: 14px;
      font-weight: 700;
    }
    .brand-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    .nav-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      padding: 6px 16px;
      cursor: pointer;
      font-size: 12px;
    }
    .nav-btn-active {
      background: #8b5cf6;
      border-color: #8b5cf6;
      color: white;
    }

    /* ====== PAGE LAYOUT ====== */
    .page {
      padding: 20px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 30px;
      margin-bottom: 15px;
    }
    h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .card-container {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .card {
      background: #161b22;
      padding: 20px;
      border-radius: 10px;
      flex: 1;
      min-width: 220px;
      text-align: center;
    }
    .label { font-size: 14px; color: #aaa; }
    .value { font-size: 28px; margin-top: 5px; }
    .positive { color: #4CAF50; }
    .negative { color: #FF5252; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #161b22;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    th {
      background-color: #21262d;
      text-align: left;
    }
    .tag {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      color: white;
    }
    .tag-eval { background-color: #f39c12; }
    .tag-live { background-color: #2ecc71; }
    .tag-status { background-color: #3498db; }

    #error {
      background: #ff4444;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }

    section { margin-top: 10px; }
    .hidden { display: none; }

    /* LOGIN */
    .login-box {
      max-width: 320px;
      background: #161b22;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .login-input {
      width: 100%;
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #0d1117;
      color: #e5e7eb;
      font-size: 14px;
    }
    .login-btn {
      width: 100%;
      margin-top: 15px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: #8b5cf6;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    /* FORMULARIOS CUENTAS / MOVIMIENTOS */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .form-box {
      background: #161b22;
      padding: 16px 18px;
      border-radius: 10px;
      font-size: 14px;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .form-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .form-input,
    .form-select {
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #0d1117;
      color: #e5e7eb;
      font-size: 13px;
    }
    .form-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
    }
    .form-submit {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #8b5cf6;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }
    .form-msg {
      margin-top: 6px;
      font-size: 12px;
    }
    .form-msg-ok {
      color: #4caf50;
    }
    .form-msg-error {
      color: #ff5252;
    }
  </style>
</head>

<body>

  <!-- BARRA SUPERIOR -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-logo">T</div>
      <div class="brand-text">
        <div class="brand-title">TRACKER</div>
        <div class="brand-subtitle">Franco Trading</div>
      </div>
    </div>
    <div class="nav-buttons">
      <button class="nav-btn nav-btn-active" id="btnDashboard">Dashboard</button>
      <button class="nav-btn" id="btnAccounts">Cuentas</button>
      <button class="nav-btn" id="btnLogin">Login</button>
    </div>
  </div>

  <div class="page">
    <div id="error"></div>

    <!-- SECCI칍N DASHBOARD -->
    <section id="dashboardSection">
      <h1>Dashboard de Cuentas de Fondeo</h1>

      <div class="card-container">
        <div class="card">
          <div class="label">EVALUACIONES</div>
          <div class="value" id="evaluations">-</div>
        </div>
        <div class="card">
          <div class="label">CUENTAS LIVE</div>
          <div class="value" id="liveAccounts">-</div>
        </div>
        <div class="card">
          <div class="label">FUNDING RATIO</div>
          <div class="value" id="fundingRatio">-</div>
        </div>
        <div class="card">
          <div class="label">GASTOS TOTALES</div>
          <div class="value" id="expenses">-</div>
        </div>
        <div class="card">
          <div class="label">GANANCIAS TOTALES</div>
          <div class="value" id="withdrawals">-</div>
        </div>
        <div class="card">
          <div class="label" id="netProfitLabel">BENEFICIO NETO</div>
          <div class="value" id="netProfit">-</div>
        </div>
      </div>
    </section>

    <!-- SECCI칍N CUENTAS -->
    <section id="accountsSection" class="hidden">
      <h2>Cuentas</h2>

      <div class="form-grid">
        <!-- Alta cuenta -->
        <div class="form-box">
          <h3>Agregar cuenta</h3>
          <div class="form-row">
            <label class="form-label" for="accName">Nombre / etiqueta</label>
            <input id="accName" class="form-input" placeholder="Ej: FT 100k eval dic-25" />
          </div>
          <div class="form-row">
            <label class="form-label" for="accType">Tipo</label>
            <select id="accType" class="form-select">
              <option value="evaluation">Evaluaci칩n</option>
              <option value="live">Live</option>
            </select>
          </div>
          <div class="form-row">
            <label class="form-label" for="accStatus">Estado (visual)</label>
            <input id="accStatus" class="form-input" placeholder="activa / quemada / etc (solo visual)" />
          </div>
          <div class="form-row">
            <label class="form-label" for="accPrice">Precio (USD)</label>
            <input id="accPrice" type="number" step="0.01" class="form-input" />
          </div>
          <div class="form-row">
            <label class="form-label" for="accSize">Tama침o de cuenta</label>
            <input id="accSize" type="number" class="form-input" placeholder="Ej: 100000" />
          </div>
          <div class="form-row">
            <label class="form-label" for="accStart">Fecha de inicio</label>
            <input id="accStart" type="date" class="form-input" />
          </div>
          <div class="form-actions">
            <button class="form-submit" id="saveAccountBtn">Guardar cuenta</button>
          </div>
          <div id="accountMsg" class="form-msg"></div>
        </div>

        <!-- Alta movimiento -->
        <div class="form-box">
          <h3>Registrar movimiento</h3>
          <div class="form-row">
            <label class="form-label" for="txType">Tipo de movimiento</label>
            <select id="txType" class="form-select">
              <option value="expense">Gasto (compra, mensualidad, fee)</option>
              <option value="withdrawal">Retiro</option>
            </select>
          </div>
          <div class="form-row">
            <label class="form-label" for="txAmount">Monto (USD)</label>
            <input id="txAmount" type="number" step="0.01" class="form-input" />
          </div>
          <div class="form-actions">
            <button class="form-submit" id="saveTxBtn">Guardar movimiento</button>
          </div>
          <div id="txMsg" class="form-msg"></div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Empresa</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Precio</th>
            <th>Tama침o</th>
            <th>Inicio</th>
          </tr>
        </thead>
        <tbody id="accountsTableBody"></tbody>
      </table>
    </section>

    <!-- SECCI칍N LOGIN -->
    <section id="loginSection" class="hidden">
      <h2>Login</h2>

      <div class="login-box">
        <label for="loginEmail">Email</label>
        <input
          id="loginEmail"
          type="email"
          class="login-input"
          placeholder="tu@email.com"
        />

        <label for="loginPassword">Contrase침a</label>
        <input
          id="loginPassword"
          type="password"
          class="login-input"
          placeholder="********"
        />

        <button class="login-btn" id="loginButton">
          Iniciar sesi칩n (no funcional a칰n)
        </button>
      </div>
    </section>
  </div>

  <!-- SUPABASE JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- JS PRINCIPAL -->
  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = "https://zflewnplzaiarasfuzcf.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbGV3bnBsemFpYXJhc2Z1emNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTIwMzEsImV4cCI6MjA4MDE4ODAzMX0.UgdX9H7QOKWpDLpApMYzCaA01oIxT9r2psnvJYfkcgg";

    const USER_ID = "00000000-0000-0000-0000-000000000001";

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function formatCurrency(num) {
      const n = Number(num);
      if (isNaN(n)) return "-";
      return n.toLocaleString("en-US", {
        style: "currency",
        currency: "USD",
      });
    }

    async function loadDashboard() {
      const errorBox = document.getElementById("error");
      errorBox.style.display = "none";
      errorBox.textContent = "";

      const { data: accounts, error: accError } = await supabaseClient
        .from("accounts")
        .select("*")
        .eq("user_id", USER_ID);

      if (accError) {
        console.error("Error accounts:", accError);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Error al leer cuentas: " +
          (accError.message || JSON.stringify(accError));
        return;
      }

      const { data: transactions, error: txError } = await supabaseClient
        .from("transactions")
        .select("*")
        .eq("user_id", USER_ID);

      if (txError) {
        console.error("Error transactions:", txError);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Error al leer movimientos: " +
          (txError.message || JSON.stringify(txError));
        return;
      }

      updateCards(accounts || [], transactions || []);
      updateAccountsTable(accounts || []);
    }

    function updateCards(accounts, transactions) {
      const evals = accounts.filter((a) => a.type === "evaluation").length;
      const live = accounts.filter((a) => a.type === "live").length;

      const expenses = transactions
        .filter((t) => t.type === "expense")
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);

      const withdrawals = transactions
        .filter((t) => t.type === "withdrawal")
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);

      const net = withdrawals - expenses;

      document.getElementById("evaluations").textContent = evals;
      document.getElementById("liveAccounts").textContent = live;
      document.getElementById("fundingRatio").textContent =
        evals === 0 ? "-" : ((live / evals) * 100).toFixed(1) + "%";

      document.getElementById("expenses").textContent =
        formatCurrency(expenses);
      document.getElementById("withdrawals").textContent =
        formatCurrency(withdrawals);

      const netEl = document.getElementById("netProfit");
      const label = document.getElementById("netProfitLabel");
      netEl.textContent = formatCurrency(net);

      if (net > 0) {
        netEl.classList.add("positive");
        netEl.classList.remove("negative");
        label.textContent = "BENEFICIO NETO (positivo)";
      } else if (net < 0) {
        netEl.classList.add("negative");
        netEl.classList.remove("positive");
        label.textContent = "BENEFICIO NETO (negativo)";
      } else {
        netEl.classList.remove("positive", "negative");
        label.textContent = "BENEFICIO NETO";
      }
    }

    function updateAccountsTable(accounts) {
      const tbody = document.getElementById("accountsTableBody");
      tbody.innerHTML = "";

      if (!accounts || accounts.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.style.textAlign = "center";
        td.style.color = "#777";
        td.textContent = "No hay cuentas cargadas a칰n (conexi칩n OK).";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      accounts.forEach((acc) => {
        const tr = document.createElement("tr");

        const typeHtml =
          '<span class="tag ' +
          (acc.type === "evaluation" ? "tag-eval" : "tag-live") +
          '">' +
          (acc.type === "evaluation" ? "Evaluaci칩n" : "Live") +
          "</span>";

        const statusHtml =
          '<span class="tag tag-status">' + (acc.status || "-") + "</span>";

        tr.innerHTML = `
          <td>${acc.name || "-"}</td>
          <td>-</td>
          <td>${typeHtml}</td>
          <td>${statusHtml}</td>
          <td>${formatCurrency(acc.price)}</td>
          <td>${acc.size ? Number(acc.size).toLocaleString("en-US") : "-"}</td>
          <td>${acc.start_date || "-"}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    // NAV
    const btnDashboard = document.getElementById("btnDashboard");
    const btnAccounts  = document.getElementById("btnAccounts");
    const btnLogin     = document.getElementById("btnLogin");

    const dashboardSection = document.getElementById("dashboardSection");
    const accountsSection  = document.getElementById("accountsSection");
    const loginSection     = document.getElementById("loginSection");

    function setActive(tab) {
      [btnDashboard, btnAccounts, btnLogin].forEach((b) =>
        b.classList.remove("nav-btn-active")
      );
      if (tab === "dashboard") btnDashboard.classList.add("nav-btn-active");
      if (tab === "accounts")  btnAccounts.classList.add("nav-btn-active");
      if (tab === "login")     btnLogin.classList.add("nav-btn-active");

      dashboardSection.classList.add("hidden");
      accountsSection.classList.add("hidden");
      loginSection.classList.add("hidden");

      if (tab === "dashboard") dashboardSection.classList.remove("hidden");
      if (tab === "accounts")  accountsSection.classList.remove("hidden");
      if (tab === "login")     loginSection.classList.remove("hidden");
    }

    btnDashboard.onclick = () => setActive("dashboard");
    btnAccounts.onclick  = () => setActive("accounts");
    btnLogin.onclick     = () => setActive("login");

    // GUARDAR CUENTA
    const saveAccountBtn = document.getElementById("saveAccountBtn");
    const accountMsg     = document.getElementById("accountMsg");

    saveAccountBtn.onclick = async () => {
      accountMsg.textContent = "";
      accountMsg.className = "form-msg";

      const name   = document.getElementById("accName").value.trim();
      const type   = document.getElementById("accType").value;
      const price  = parseFloat(document.getElementById("accPrice").value || "0");
      const size   = document.getElementById("accSize").value
        ? parseFloat(document.getElementById("accSize").value)
        : null;
      const start  = document.getElementById("accStart").value || null;

      if (!name) {
        accountMsg.textContent = "El nombre de la cuenta es obligatorio.";
        accountMsg.classList.add("form-msg-error");
        return;
      }

      const { error } = await supabaseClient.from("accounts").insert([
        {
          user_id: USER_ID,
          name,
          type,
          price,
          size,
          start_date: start,
          status: "active"   // 游녣 valor v치lido para tu constraint y NOT NULL
        },
      ]);

      if (error) {
        console.error("Error guardando cuenta:", error);
        accountMsg.textContent =
          "Error al guardar la cuenta: " +
          (error.message || JSON.stringify(error));
        accountMsg.classList.add("form-msg-error");
        return;
      }

      accountMsg.textContent = "Cuenta guardada correctamente.";
      accountMsg.classList.add("form-msg-ok");

      document.getElementById("accName").value = "";
      document.getElementById("accStatus").value = "";
      document.getElementById("accPrice").value = "";
      document.getElementById("accSize").value = "";
      document.getElementById("accStart").value = "";

      await loadDashboard();
    };

    // GUARDAR MOVIMIENTO
    const saveTxBtn = document.getElementById("saveTxBtn");
    const txMsg     = document.getElementById("txMsg");

    saveTxBtn.onclick = async () => {
      txMsg.textContent = "";
      txMsg.className = "form-msg";

      const type   = document.getElementById("txType").value;
      const amount = parseFloat(document.getElementById("txAmount").value || "0");

      if (!amount || amount <= 0) {
        txMsg.textContent = "Ingres치 un monto v치lido.";
        txMsg.classList.add("form-msg-error");
        return;
      }

      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

      const { error } = await supabaseClient
        .from("transactions")
        .insert([
          {
            user_id: USER_ID,
            type,
            amount,
            date: today
          },
        ]);

      if (error) {
        console.error("Error guardando movimiento:", error);
        txMsg.textContent =
          "Error al guardar el movimiento: " +
          (error.message || JSON.stringify(error));
        txMsg.classList.add("form-msg-error");
        return;
      }

      txMsg.textContent = "Movimiento guardado correctamente.";
      txMsg.classList.add("form-msg-ok");

      document.getElementById("txAmount").value = "";

      await loadDashboard();
    };

    loadDashboard();
  </script>

</body>
</html>

