<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Cuentas de Fondeo</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: white;
      margin: 0;
      padding: 20px;
    }
    h1 { font-size: 28px; margin-bottom: 20px; }
    h2 { margin-top: 30px; }
    .card-container {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .card {
      background: #161b22;
      padding: 20px;
      border-radius: 10px;
      flex: 1;
      min-width: 220px;
      text-align: center;
    }
    .label { font-size: 14px; color: #aaa; }
    .value { font-size: 28px; margin-top: 5px; }
    .positive { color: #4CAF50; }
    .negative { color: #FF5252; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #161b22;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    th {
      background-color: #21262d;
      text-align: left;
    }
    .tag {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      color: white;
    }
    .tag-eval { background-color: #f39c12; }
    .tag-live { background-color: #2ecc71; }
    .tag-status { background-color: #3498db; }

    #error {
      background: #ff4444;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }
  </style>
</head>

<body>

  <h1>Dashboard de Cuentas de Fondeo</h1>

  <div id="error"></div>

  <div class="card-container">
    <div class="card">
      <div class="label">EVALUACIONES</div>
      <div class="value" id="evaluations">-</div>
    </div>
    <div class="card">
      <div class="label">CUENTAS LIVE</div>
      <div class="value" id="liveAccounts">-</div>
    </div>
    <div class="card">
      <div class="label">FUNDING RATIO</div>
      <div class="value" id="fundingRatio">-</div>
    </div>
    <div class="card">
      <div class="label">GASTOS TOTALES</div>
      <div class="value" id="expenses">-</div>
    </div>
    <div class="card">
      <div class="label">GANANCIAS TOTALES</div>
      <div class="value" id="withdrawals">-</div>
    </div>
    <div class="card">
      <div class="label" id="netProfitLabel">BENEFICIO NETO</div>
      <div class="value" id="netProfit">-</div>
    </div>
  </div>

  <h2>Cuentas</h2>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Empresa</th>
        <th>Tipo</th>
        <th>Estado</th>
        <th>Precio</th>
        <th>Tama√±o</th>
        <th>Inicio</th>
      </tr>
    </thead>
    <tbody id="accountsTableBody"></tbody>
  </table>

  <!-- Cargamos Supabase JS desde CDN, sin m√≥dulos -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // üîë TUS DATOS DE SUPABASE
    const SUPABASE_URL = "https://zflewnplzaiarasfuzcf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbGV3bnBsemFpYXJhc2Z1emNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTIwMzEsImV4cCI6MjA4MDE4ODAzMX0.UgdX9H7QOKWpDLpApMYzCaA01oIxT9r2psnvJYfkcgg";

    // Usuario fijo (solo vos por ahora)
    const USER_ID = "00000000-0000-0000-0000-000000000001";

    // Cliente Supabase usando la variable global window.supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function formatCurrency(num) {
      const n = Number(num);
      if (isNaN(n)) return "-";
      return n.toLocaleString("es-ES", {
        style: "currency",
        currency: "EUR",
      });
    }

    async function loadDashboard() {
      const errorBox = document.getElementById("error");
      errorBox.style.display = "none";
      errorBox.textContent = "";

      try {
        // Cuentas
        const { data: accounts, error: accError } = await supabase
          .from("accounts")
          .select("*")
          .eq("user_id", USER_ID);

        if (accError) throw accError;

        // Transacciones
        const { data: transactions, error: txError } = await supabase
          .from("transactions")
          .select("*")
          .eq("user_id", USER_ID);

        if (txError) throw txError;

        updateCards(accounts, transactions);
        updateAccountsTable(accounts);

      } catch (err) {
        console.error("Error cargando datos:", err);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Error al cargar datos desde Supabase. Abr√≠ la consola del navegador para m√°s detalles.";
      }
    }

    function updateCards(accounts, transactions) {
      const evals = accounts.filter(a => a.type === "evaluation").length;
      const live = accounts.filter(a => a.type === "live").length;

      const expenses = transactions
        .filter(t => t.type === "expense")
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);

      const withdrawals = transactions
        .filter(t => t.type === "withdrawal")
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);

      const net = withdrawals - expenses;

      document.getElementById("evaluations").textContent = evals;
      document.getElementById("liveAccounts").textContent = live;
      document.getElementById("fundingRatio").textContent =
        evals === 0 ? "-" : ((live / evals) * 100).toFixed(1) + "%";

      document.getElementById("expenses").textContent = formatCurrency(expenses);
      document.getElementById("withdrawals").textContent = formatCurrency(withdrawals);

      const netEl = document.getElementById("netProfit");
      const label = document.getElementById("netProfitLabel");
      netEl.textContent = formatCurrency(net);

      if (net > 0) {
        netEl.classList.add("positive");
        netEl.classList.remove("negative");
        label.textContent = "BENEFICIO NETO (positivo)";
      } else if (net < 0) {
        netEl.classList.add("negative");
        netEl.classList.remove("positive");
        label.textContent = "BENEFICIO NETO (negativo)";
      } else {
        netEl.classList.remove("positive", "negative");
        label.textContent = "BENEFICIO NETO";
      }
    }

    function updateAccountsTable(accounts) {
      const tbody = document.getElementById("accountsTableBody");
      tbody.innerHTML = "";

      if (!accounts || accounts.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.style.textAlign = "center";
        td.style.color = "#777";
        td.textContent = "No hay cuentas c

